<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title></title>
</head>
<body>
  <!-- HTML form -->
  <form id="my-form">
    <label for="name">Name:</label>
    <input type="text" id="name" name="name" maxlength="32"><br>

    <label for="addressline1">Address Line 1:</label>
    <input type="text" id="addressline1" name="addressline1" maxlength="36"><br>

    <label for="addressline2">Address Line 2:</label>
    <input type="text" id="addressline2" name="addressline2" maxlength="36"><br>

    <label for="addressline3">Address Line 3:</label>
    <input type="text" id="addressline3" name="addressline3" maxlength="36"><br>

    <label for="gsdnumber">GSD Number:</label>
    <input type="text" id="gsdnumber" name="gsdnumber" maxlength="30"><br>

    <label for="billno">Bill No:</label>
    <input type="number" id="billno" name="billno"><br>

    <label for="billdate">Bill Date:</label>
    <input type="date" id="billdate" name="billdate" value="{{(new Date()).toISOString().substr(0,10)}}"><br>

    <table>
      <thead>
        <tr>
          <th>CNS No</th>
          <th>Date</th>
          <th>Pkgs</th>
          <th>To Station</th>
          <th>Consignor/Consignee</th>
          <th>Freight</th>
          <th>Other charges</th>
          <!--<th>Total Amount</th>-->
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input type="number" name="cns_no[]" max="99999999"/></td>
          <td><input type="date" name="date[]" /></td>
          <td><input type="number" name="pkgs[]"  max="99999"/></td>
          <td><input type="text" name="to_station[]" maxlength="7" /></td>
          <td><input type="text" name="consignor_consignee[]" maxlength="20" /></td>
          <td><input type="number" name="freight[]" max="99999999" /></td>
          <td><input type="text" name="other_charges[]" max="9999" /></td>
          <!--<td><input type="text" name="total_amount[]" max="999999999" /></td>-->
        </tr>
        <tr>
          <td><input type="number" name="cns_no[]" max="99999999"/></td>
          <td><input type="date" name="date[]" /></td>
          <td><input type="number" name="pkgs[]"  max="99999"/></td>
          <td><input type="text" name="to_station[]" maxlength="7" /></td>
          <td><input type="text" name="consignor_consignee[]" maxlength="20" /></td>
          <td><input type="number" name="freight[]" max="99999999" /></td>
          <td><input type="text" name="other_charges[]" max="9999" /></td>
          <!--<td><input type="text" name="total_amount[]" max="999999999" /></td>-->
        </tr>
        <tr>
          <td><input type="number" name="cns_no[]" max="99999999"/></td>
          <td><input type="date" name="date[]" /></td>
          <td><input type="number" name="pkgs[]"  max="99999"/></td>
          <td><input type="text" name="to_station[]" maxlength="7" /></td>
          <td><input type="text" name="consignor_consignee[]" maxlength="20" /></td>
          <td><input type="number" name="freight[]" max="99999999" /></td>
          <td><input type="text" name="other_charges[]" max="9999" /></td>
          <!--<td><input type="text" name="total_amount[]" max="999999999" /></td>-->
        </tr>
        <tr>
          <td><input type="number" name="cns_no[]" max="99999999"/></td>
          <td><input type="date" name="date[]" /></td>
          <td><input type="number" name="pkgs[]"  max="99999"/></td>
          <td><input type="text" name="to_station[]" maxlength="7" /></td>
          <td><input type="text" name="consignor_consignee[]" maxlength="20" /></td>
          <td><input type="number" name="freight[]" max="99999999" /></td>
          <td><input type="text" name="other_charges[]" max="9999" /></td>
          <!--<td><input type="text" name="total_amount[]" max="999999999" /></td>-->
        </tr>
        <tr>
          <td><input type="number" name="cns_no[]" max="99999999"/></td>
          <td><input type="date" name="date[]" /></td>
          <td><input type="number" name="pkgs[]"  max="99999"/></td>
          <td><input type="text" name="to_station[]" maxlength="7" /></td>
          <td><input type="text" name="consignor_consignee[]" maxlength="20" /></td>
          <td><input type="number" name="freight[]" max="99999999" /></td>
          <td><input type="text" name="other_charges[]" max="9999" /></td>
          <!--<td><input type="text" name="total_amount[]" max="999999999" /></td>-->
        </tr>
      </tbody>
    </table>

    <input type="checkbox" name="CGST" id="cgst" value="cgst">
    <label for="cgst">CGST</label><br>

    <input type="checkbox" name="SGST" id="sgst" value="sgst">
    <label for="sgst">SGST</label><br>

    <input type="checkbox" name="IGST" id="igst" value="igst">
    <label for="igst">IGST</label><br>

    <button type="submit">Generate PDF</button>
  </form>
  <!--<button onclick="downloadform()">Download Form</button>-->
  <!--<a href="TAX-INVOICE.pdf" download> ttest</a> -->

  <!-- Script to generate PDF -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.16.0/pdf-lib.min.js"></script>

  <script src="https://unpkg.com/downloadjs@1.4.7"></script>


  <script>
    const form = document.getElementById("my-form");
    form.addEventListener("submit", generatePDF);

    async function generatePDF(event) {
      event.preventDefault();

      // Retrieve form data
      const name = document.getElementById("name").value;
      const addressline1 = document.getElementById("addressline1").value;
      const addressline2 = document.getElementById("addressline2").value;
      const addressline3 = document.getElementById("addressline3").value;
      const billno = document.getElementById("billno").value;
      const billdate = document.getElementById("billdate").value;
      const gsdnumber = document.getElementById("gsdnumber").value;

      // Load PDF template
      //const pdfDoc = await PDFLib.PDFDocument.load("TAX-INVOICE.pdf");

      // Fetch the PDF file as an array buffer
      const response = await fetch("TAX-INVOICE.pdf");
      const arrayBuffer = await response.arrayBuffer();

      // Load the PDF document from array buffer
      const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);

      // Get page 1 of the PDF template
      const page = pdfDoc.getPages()[0];

      // Embed the Helvetica font
      const helveticaFont = await pdfDoc.embedFont('Helvetica');

      // Add user input to the PDF template
      
      page.setFontSize(16);

      page.drawText(name, { x: 68, y: 632,});
      page.drawText(addressline1, { x: 44,y: 610});
      page.drawText(addressline2, { x: 44,y: 588});
      page.drawText(addressline3, { x: 44,y: 566});

      page.drawText(gsdnumber, { x: 85,y: 536});
      

      page.setFontSize(12);
      page.drawText(billno, { x: 470, y: 659, fontSize: 74});
      page.drawText(billdate, { x: 470, y: 624, fontSize: 74});


      // Select all the rows in the table body
      const rows = document.querySelectorAll('tbody tr');

      var table_y = 447;
      var totalCost = 0;
      // Loop through each row and extract the column values
      rows.forEach(row => {

      const cnsNo = row.querySelector('input[name="cns_no[]"]').value;
      const date = row.querySelector('input[name="date[]"]').value;
      const pkgs = row.querySelector('input[name="pkgs[]"]').value;
      const toStation = row.querySelector('input[name="to_station[]"]').value;
      const consignorConsignee = row.querySelector('input[name="consignor_consignee[]"]').value;
      const freightInput = row.querySelector('input[name="freight[]"]');
      const freight = (freightInput.value).trim() === '' ? 0 : parseFloat(freightInput.value);
      const otherChargesInput = row.querySelector('input[name="other_charges[]"]');
      const otherCharges = (otherChargesInput.value).trim() === '' ? 0 : parseFloat(otherChargesInput.value);
      var totalAmount = freight+otherCharges;

      
      // Do something with the column values (e.g. log them to the console)
      console.log(cnsNo, date, pkgs, toStation, consignorConsignee, freight, otherCharges, totalAmount);

      page.drawText(cnsNo, { x: 44,y: table_y});
      page.drawText(date,  { x: 104,y: table_y});
      page.drawText(pkgs, { x: 172,y: table_y});
      page.drawText(toStation, { x: 210,y: table_y});
      page.drawText(consignorConsignee, { x: 254,y: table_y});
      page.drawText(freight.toString(), { x: 372,y: table_y});
      page.drawText(otherCharges.toString(), { x: 444,y: table_y});
      page.drawText(totalAmount.toString(), { x: 490,y: table_y});

      table_y -= 24;
      totalCost += totalAmount;

      });

      page.drawText(totalCost.toString(), { x: 490,y: table_y + 6});

      const cgst = document.getElementById("cgst").value === 'cgst' ?  (( 2.5/100) * totalCost).toFixed(2) : 0;
      const sgst = document.getElementById("sgst").value === 'sgst' ?  (( 2.5/100) * totalCost).toFixed(2) : 0;
      const igst = document.getElementById("igst").value === 'igst' ?  (( 5/100) * totalCost).toFixed(2) : 0;
      

      page.drawText(cgst.toString(), { x: 108,y: 307});
      page.drawText(sgst.toString(), { x: 108,y: 280});
      page.drawText(igst.toString(), { x: 108,y: 253});

      // Save PDF as blob
      const pdfBytes = await pdfDoc.save();

      // Create URL for the PDF blob
      const pdfUrl = URL.createObjectURL(new Blob([pdfBytes], { type: "application/pdf" }));

      // Embed PDF in HTML
      const pdfEmbed = `<object data="${pdfUrl}" type="application/pdf" width="100%" height="600px">
                        <p>PDF cannot be displayed.</p>
                      </object>`;
      document.getElementById("pdf-container").innerHTML = pdfEmbed;
    }
  </script>

  <!-- Container for the PDF -->
  <div id="pdf-container"></div>
</body>
</html>


